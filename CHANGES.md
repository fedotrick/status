# Изменения: Исправление валидации и удаление кнопки QR

## Проблемы, которые были исправлены

### 1. Удалена кнопка "Сканировать QR"
- **Причина**: USB QR-сканер работает как клавиатура и автоматически вводит номер в активное текстовое поле
- **Действие**: Удалена кнопка и метод `on_scan_qr_button_press`
- **Комментарий**: Добавлен комментарий в коде, объясняющий, что USB-сканер работает автоматически

### 2. КРИТИЧНО: Добавлена проверка существования карты в БД
- **Проблема**: Система не проверяла, существует ли карта в базе данных (750 записей)
- **Старое поведение**: При вводе любого номера система создавала новую запись или обновляла существующую
- **Новое поведение**: 
  1. Проверяет существование карты в БД
  2. Если карты НЕТ → ошибка "Маршрутная карта №XXXXXX не найдена в базе данных"
  3. Если карта ЕСТЬ и статус "Завершена" → ошибка "Маршрутная карта №XXXXXX уже завершена"
  4. Если карта ЕСТЬ и другой статус → успешное обновление на "Завершена"

## Изменения в коде

### route_card_app.py

#### 1. DatabaseManager.complete_route_card
- **Изменен возвращаемый тип**: `bool` → `Tuple[bool, str]`
- **Добавлена проверка существования**: Метод теперь сначала проверяет, есть ли карта в БД
- **Удалена логика INSERT**: Больше не создает новые записи, только обновляет существующие
- **Возвращает сообщения об ошибках**: При неудаче возвращает понятное сообщение

```python
# БЫЛО:
def complete_route_card(self, route_card_number: str) -> bool:
    if exists:
        UPDATE ...
    else:
        INSERT ...  # ПРОБЛЕМА: создает новые записи!
    return success

# СТАЛО:
def complete_route_card(self, route_card_number: str) -> Tuple[bool, str]:
    if not exists:
        return False, "Маршрутная карта №... не найдена в базе данных"
    UPDATE ...
    return success, None
```

#### 2. RouteCardApp.on_complete_button_press
- **Обновлена обработка результата**: Теперь получает кортеж (success, error_message)
- **Улучшены сообщения об ошибках**: Показывает конкретные причины неудачи

#### 3. RouteCardApp.build_edit_tab
- **Удалена кнопка "Сканировать QR код"**
- **Удален разделитель "или"**
- **Добавлен комментарий**: Объясняет, что USB-сканер работает автоматически

#### 4. Удален метод on_scan_qr_button_press
- Полностью удален код для работы с камерой и библиотеками opencv-python, pyzbar

### test_simplified_route_card_input.py

Обновлены тесты для соответствия новому поведению:
- `test_complete_route_card_fails_for_non_existent_card` (был `test_complete_route_card_creates_new_record`)
- Все интеграционные тесты теперь создают карты в БД перед попыткой завершения
- Добавлен новый тест `test_complete_non_existent_route_card_fails`
- Обновлены проверки возвращаемых значений (теперь кортеж вместо boolean)

## Валидация

### Этапы проверки (в правильном порядке):

1. **Проверка формата** (уже была):
   - 6 цифр (от 000001 до 999999)
   - Только цифры
   - Нормализация с ведущими нулями

2. **Проверка завершения** (уже была):
   - `check_route_card_completed()` проверяет, не завершена ли уже карта
   - Вызывается в UI перед попыткой завершения

3. **Проверка существования** (НОВАЯ):
   - `complete_route_card()` проверяет, существует ли карта в БД
   - Возвращает ошибку, если карты нет

4. **Обновление статуса**:
   - UPDATE (не INSERT!)
   - Устанавливает статус "Завершена"
   - Обновляет дату создания

## Примеры сценариев

### Сценарий 1: Карты нет в БД (750 записей)
```
Ввод: 999999
Действие: Проверка формата → OK → Проверка завершения → НЕТ → Попытка завершить
Результат: "Маршрутная карта №999999 не найдена в базе данных"
```

### Сценарий 2: Карта есть, статус НЕ "Завершена"
```
Ввод: 000500 (существует, статус "В работе")
Действие: Проверка формата → OK → Проверка завершения → НЕТ → Завершение
Результат: "Маршрутная карта №000500 успешно завершена"
БД: статус изменен на "Завершена"
```

### Сценарий 3: Карта уже завершена
```
Ввод: 000001 (существует, статус "Завершена")
Действие: Проверка формата → OK → Проверка завершения → ДА
Результат: "Маршрутная карта №000001 уже завершена"
БД: не меняется
```

### Сценарий 4: USB-сканер
```
Действие: Отсканировать QR с номером 000123 USB-сканером
Результат: Номер автоматически вводится в текстовое поле
Действие: Нажать "Завершить"
Результат: Применяется вся валидация (формат → существование → статус)
```

## Acceptance Criteria (все выполнены)

- ✅ Кнопка "Сканировать QR" удалена из интерфейса
- ✅ USB QR-сканер автоматически вводит номер в текстовое поле
- ✅ Система проверяет существование карты в БД (750 записей)
- ✅ Если карты НЕТ в БД → ошибка "не найдена"
- ✅ Если карта ЕСТЬ, но статус "Завершена" → ошибка "уже завершена"
- ✅ Если карта ЕСТЬ и статус другой → успешное обновление
- ✅ Валидация формата (6 цифр, 000001-999999) работает
- ✅ Все сообщения об ошибках понятны и информативны
- ✅ Логика UPDATE, а не INSERT (обновляем существующую запись)
- ✅ Тесты обновлены и проходят

## Технические детали

- База данных: `маршрутные_карты.db` (750 записей)
- Таблица: `маршрутные_карты`
- Столбец номера: `Номер_бланка`
- Столбец статуса: `Статус`
- Диапазон существующих карт: 000001 - 000750
- Используется UPDATE, не INSERT
